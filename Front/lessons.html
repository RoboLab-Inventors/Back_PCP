<!DOCTYPE html>
<html lang="en">

<head>
    <title>Document</title>
</head>

<body onload="caricaLezioni()">
    <div id="container"></div>   
    Aggiungi lezione: 
    <input type="text" id="nomeLezione" placeholder="Nome lezione">
    <input type="text" id="testoLezione" placeholder="Testo lezione">
    <button onclick="aggiungiLezione()">Aggiungi</button>
    <br>
    Modifica lezione:
    <select id="selectLezione" onchange="popolaCampi()"><option value="">Seleziona una lezione</option></select><br>
    <input type="text" id="nomeLezioneModifica" placeholder="Nome lezione" disabled>
    <textarea id="testoLezioneModifica" disabled></textarea><br><br>
    Rimuovi lezione:     
    <select id="rimuoviLezione" onchange="eliminaCampi  ()"><option value="">Seleziona una lezione</option></select><br>

    <button onclick="modificaLezione()">Modifica</button>
    
</body>
<script>
    function caricaCampi() {
        const dataSource = document.getElementById("container");
        const children = Array.from(dataSource.children); // Converti HTMLCollection in array
        children.forEach(element => {
            const option = document.createElement('option');
            option.value = element.querySelector('h3').innerText;
            option.innerHTML = element.querySelector('h3').innerText; // Assumi che il nome della lezione sia in un <h3>
            document.getElementById("selectLezione").appendChild(option);
        });
    }

    function popolaCampi() {
        const choice = document.getElementById("selectLezione").value;
        console.log(`Scelta: ${choice}`);
        document.getElementById("nomeLezioneModifica").disabled = false;
        document.getElementById("testoLezioneModifica").disabled = false;
        const dataSource = document.getElementById("container");
        const children = Array.from(dataSource.children); // Converti HTMLCollection in array
        children.forEach(element => {
            const h3Text = element.querySelector('h3').innerText;
            console.log(`h3Text: ${h3Text}`);
            if (h3Text === choice) {
                document.getElementById("nomeLezioneModifica").value = h3Text;
                document.getElementById("testoLezioneModifica").value = element.querySelector('p').innerText;
            }
        });
    }

    async function caricaLezioni() {
        fetch("http://localhost:3000/lessons", {
            method: "GET",
            headers: {
                "Content-Type": "application/json"
            }
        }).then(response => response.json())
            .then(data => {
                data.forEach(element => {
                    const div = document.createElement('div');
                    div.id = "Lezione" + element.id;
                    div.innerHTML = `<h3>${element.nomeLezione}</h3><p>${element.testoLezione}</p>`;
                    document.getElementById("container").appendChild(div);
                });
                caricaCampi(); // Chiama caricaCampi dopo aver caricato le lezioni
            }).catch(error => {
                console.error('Errore durante il caricamento delle lezioni:', error);
            });
    }

    async function aggiungiLezione() {
        const nomeLezione = document.getElementById("nomeLezione").value;
        const testoLezione = document.getElementById("testoLezione").value;
        fetch("http://localhost:3000/addLesson", {
            method: "POST",
            headers: {
                "Content-Type": "application/json"
            },
            body: JSON.stringify({
                nomeLezione: nomeLezione,
                testoLezione: testoLezione
            })
        }).then(response => response.json())
          .then(data => {
              console.log(data);
              caricaLezioni(); // Ricarica le lezioni dopo aver aggiunto una nuova lezione
          }).catch(error => {
              console.error('Errore durante l\'aggiunta della lezione:', error);
          });
    }
    async function modificaLezione() {
        const nomeLezione = document.getElementById("nomeLezioneModifica").value;
        const testoLezione = document.getElementById("testoLezioneModifica").value;
        const selectLezione = document.getElementById("selectLezione").value;
        console.log(`Nome lezione: ${nomeLezione}, Testo lezione: ${testoLezione}, Lezione attuale: ${selectLezione}`);
        fetch("http://localhost:3000/modifyLesson", {
            method: "PUT",
            headers: {
                "Content-Type": "application/json"
            },
            body: JSON.stringify({
                nomeLezione: nomeLezione,
                testoLezione: testoLezione,
                lezioneSelezionata: selectLezione
            })
        }).then(response => response.json())
          .then(data => {
              console.log(data);
              document.getElementById("container").value = "";
              caricaLezioni(); // Ricarica le lezioni dopo aver modificato una lezione
          }).catch(error => {
              console.error('Errore durante la modifica della lezione:', error);
          });
        
    }
</script>
</html>